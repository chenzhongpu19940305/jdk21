<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.MenuMapper">

    <!-- 结果映射 -->
    <resultMap id="MenuResultMap" type="com.example.demo.entity.Menu">
        <id column="menu_id" property="id" />
        <result column="menu_name" property="name" />
        <result column="menu_code" property="code" />
        <result column="menu_icon" property="icon" />
        <result column="menu_sort_order" property="sortOrder" />
        <result column="menu_status" property="status" />
        <collection property="tabs" ofType="com.example.demo.entity.Tab">
            <id column="tab_id" property="id" />
            <result column="tab_name" property="name" />
            <result column="tab_code" property="code" />
            <result column="tab_sort_order" property="sortOrder" />
            <result column="tab_status" property="status" />
        </collection>
    </resultMap>

    <!-- 查询所有启用的菜单及其 Tab，按排序顺序 -->
    <select id="findAllEnabledWithTabs" resultMap="MenuResultMap">
        SELECT 
            m.id as menu_id,
            m.name as menu_name,
            m.code as menu_code,
            m.icon as menu_icon,
            m.sort_order as menu_sort_order,
            m.status as menu_status,
            t.id as tab_id,
            t.name as tab_name,
            t.code as tab_code,
            t.sort_order as tab_sort_order,
            t.status as tab_status
        FROM menu m
        LEFT JOIN tab t ON m.id = t.menu_id AND t.status = 1
        WHERE m.status = 1
        ORDER BY m.sort_order ASC, t.sort_order ASC
    </select>

    <!-- 查询所有菜单 -->
    <select id="findAll" resultMap="MenuResultMap">
        SELECT 
            m.id as menu_id,
            m.name as menu_name,
            m.code as menu_code,
            m.icon as menu_icon,
            m.sort_order as menu_sort_order,
            m.status as menu_status,
            t.id as tab_id,
            t.name as tab_name,
            t.code as tab_code,
            t.sort_order as tab_sort_order,
            t.status as tab_status
        FROM menu m
        LEFT JOIN tab t ON m.id = t.menu_id
        ORDER BY m.sort_order ASC, t.sort_order ASC
    </select>

    <!-- 根据 code 查询菜单 -->
    <select id="findByCode" resultType="com.example.demo.entity.Menu">
        SELECT id, name, code, icon, sort_order as sortOrder, status
        FROM menu
        WHERE code = #{code}
        LIMIT 1
    </select>

    <!-- 插入菜单 -->
    <insert id="insert" parameterType="com.example.demo.entity.Menu" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO menu (name, code, icon, sort_order, status)
        VALUES (#{name}, #{code}, #{icon}, #{sortOrder}, #{status})
    </insert>

    <!-- 根据 ID 删除菜单 -->
    <delete id="deleteById">
        DELETE FROM menu
        WHERE id = #{id}
    </delete>

</mapper>




